<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Prediction Visualization Conditions</title>
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #6c757d;
            font-size: 14px;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid #e9ecef;
        }

        .opacity-slider {
            width: 100px;
            height: 20px;
        }

        .opacity-label {
            font-size: 12px;
            color: #6c757d;
            min-width: 120px;
        }

        .date-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid #e9ecef;
        }

        .date-select {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }

        .date-label {
            font-size: 12px;
            color: #6c757d;
            min-width: 80px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-line {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-stock-a { background: #007bff; }
        .legend-stock-b { background: #fd7e14; }
        .legend-historical { background: #6c757d; }

        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 1fr 1fr;
            gap: 20px;
            height: 200vh;
        }

        .condition-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .condition-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .condition-description {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 15px;
        }

        .chart-container {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .chart-svg {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #ffffff;
        }

        /* Condition-specific styling */
        .condition-1 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-2 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-3 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-4 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-5 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-6 .condition-title {
            color: black;
            border-bottom-color: black;
        }

        .condition-7 .condition-title {
            color: #dc3545;
            border-bottom-color: #dc3545;
        }

        .condition-8 .condition-title {
            color: #6f42c1;
            border-bottom-color: #6f42c1;
        }

        .condition-0 .condition-title {
            color: #28a745;
            border-bottom-color: #28a745;
        }

        .condition-9 .condition-title {
            color: #17a2b8;
            border-bottom-color: #17a2b8;
        }

        /* Chart styling */
        .axis {
            font-size: 10px;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #ccc;
            shape-rendering: crispEdges;
        }

        .grid line {
            stroke: #f0f0f0;
            stroke-width: 1px;
        }

        .grid path {
            stroke-width: 0;
        }

        .historical-line {
            fill: none;
            stroke-width: 2;
        }

        .prediction-line {
            fill: none;
            stroke-width: 2;
            opacity: 0.2;
        }

        .aggregated-line {
            fill: none;
            stroke-width: 2;
            opacity: 1;
        }

        .stock-a-line {
            stroke: #007bff;
        }

        .stock-b-line {
            stroke: #fd7e14;
        }

        .hover-overlay {
            fill: transparent;
            cursor: pointer;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .visualization-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(10, 350px);
                height: auto;
            }
            
            /* Reset grid positioning for mobile */
            .condition-panel {
                grid-column: auto !important;
                grid-row: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Air Quality Prediction Visualization Conditions</h1>
            <p>Comparing four different methods of presenting prediction uncertainty</p>
        </div>

        <div class="legend">
            <!-- <div class="legend-item">
                <div class="legend-line legend-historical"></div>
                <span>Historical Data</span>
            </div> -->
            <div class="legend-item">
                <div class="legend-line legend-stock-a"></div>
                <span>City A</span>
            </div>
            <div class="legend-item">
                <div class="legend-line legend-stock-b"></div>
                <span>City B</span>
            </div>
            
            <div class="opacity-control">
                <span class="opacity-label">Alternative Lines:</span>
                <input type="range" id="alternativeOpacitySlider" class="opacity-slider" 
                       min="0.1" max="1" step="0.1" value="0.2">
                <span id="alternativeOpacityValue">0.2</span>
            </div>
            
            <div class="opacity-control">
                <span class="opacity-label">Shade Opacity:</span>
                <input type="range" id="shadeOpacitySlider" class="opacity-slider" 
                       min="0.1" max="1" step="0.1" value="0.2">
                <span id="shadeOpacityValue">0.2</span>
            </div>
            
            <div class="date-control">
                <span class="date-label">Start Date:</span>
                <select id="dateSelect" class="date-select">
                    <option value="01/01">01/01</option>
                    <option value="05/01" selected>05/01</option>
                </select>
            </div>
        </div>

        <div class="visualization-grid">
            <!-- Condition 0: Historical Only (Row 1, spans both columns) -->
            <div class="condition-panel condition-0" style="grid-column: 1 / -1; grid-row: 1;">
                <div class="condition-title">Condition 0: Historical Only</div>
                <div class="condition-description">Shows only historical data, no predictions after 6/1</div>
                <div class="chart-container">
                    <svg id="chart-0" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 1: Baseline (Row 2, spans both columns) -->
            <div class="condition-panel condition-1" style="grid-column: 1 / -1; grid-row: 2;">
                <div class="condition-title">Condition 1: Baseline</div>
                <div class="condition-description">Shows only aggregated prediction lines</div>
                <div class="chart-container">
                    <svg id="chart-1" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 2: PI Plot (Row 3, Column 1) -->
            <div class="condition-panel condition-2" style="grid-column: 1; grid-row: 3;">
                <div class="condition-title">Condition 2: PI Plot</div>
                <div class="condition-description">Shows aggregated prediction with confidence bounds</div>
                <div class="chart-container">
                    <svg id="chart-2" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 3: Ensemble Plot (Row 3, Column 2) -->
            <div class="condition-panel condition-3" style="grid-column: 2; grid-row: 3;">
                <div class="condition-title">Condition 3: Ensemble Plot</div>
                <div class="condition-description">Shows both aggregated and alternative predictions</div>
                <div class="chart-container">
                    <svg id="chart-3" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 5: PI Plot + Hover (Row 4, Column 1) -->
            <div class="condition-panel condition-5" style="grid-column: 1; grid-row: 4;">
                <div class="condition-title">Condition 5: PI Plot + Hover</div>
                <div class="condition-description">PI plot with hover to reveal individual predictions</div>
                <div class="chart-container">
                    <svg id="chart-5" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 4: Ensemble + Hover (Row 4, Column 2) -->
            <div class="condition-panel condition-4" style="grid-column: 2; grid-row: 4;">
                <div class="condition-title">Condition 4: Ensemble + Hover</div>
                <div class="condition-description">Aggregated by default, hover to reveal alternatives</div>
                <div class="chart-container">
                    <svg id="chart-4" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 6: PI → Ensemble (Row 5, Column 1) -->
            <div class="condition-panel condition-6" style="grid-column: 1; grid-row: 5;">
                <div class="condition-title">Condition 6: PI → Ensemble</div>
                <div class="condition-description">PI plot transforms to ensemble plot on hover</div>
                <div class="chart-container">
                    <svg id="chart-6" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 7: Buggy Control (Row 5, Column 2) -->
            <div class="condition-panel condition-7" style="grid-column: 2; grid-row: 5;">
                <div class="condition-title">Condition 7: Buggy Control</div>
                <div class="condition-description">Broken interactions: hover zones show wrong city data</div>
                <div class="chart-container">
                    <svg id="chart-7" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 8: Bad Control (Row 6, spans both columns) -->
            <div class="condition-panel condition-8" style="grid-column: 1 / -1; grid-row: 6;">
                <div class="condition-title">Condition 8: Bad Control</div>
                <div class="condition-description">Poor interaction: hover on invisible lines to reveal them individually</div>
                <div class="chart-container">
                    <svg id="chart-8" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>

            <!-- Condition 9: Combined PI + Ensemble (Row 7, spans both columns) -->
            <div class="condition-panel condition-9" style="grid-column: 1 / -1; grid-row: 7;">
                <div class="condition-title">Condition 9: Combined PI + Ensemble</div>
                <div class="condition-description">Shows both confidence bounds and alternative prediction lines</div>
                <div class="chart-container">
                    <svg id="chart-9" class="chart-svg" width="400" height="300"></svg>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ConditionFactory } from './display/conditionFactory.js';

        // Configuration
        const config = {
            width: 400,
            height: 300,
            margin: { top: 20, right: 20, bottom: 40, left: 50 },
            colors: {
                historical: '#6c757d',
                stockA: '#007bff',
                stockB: '#fd7e14'
            }
        };

        // Global variables
        let conditionFactory = null;
        let currentStartDate = '05/01'; // Default start date

        // Control functionality
        function initializeControls() {
            // Alternative lines opacity control
            const alternativeSlider = document.getElementById('alternativeOpacitySlider');
            const alternativeValueDisplay = document.getElementById('alternativeOpacityValue');
            
            if (alternativeSlider) {
                alternativeSlider.addEventListener('input', function() {
                    const opacity = parseFloat(this.value);
                    alternativeValueDisplay.textContent = opacity.toFixed(1);
                    
                    // Update opacity for all alternative prediction lines across all charts
                    d3.selectAll('.prediction-line')
                        .style('opacity', opacity);
                });
            }
            
            // Shade opacity control
            const shadeSlider = document.getElementById('shadeOpacitySlider');
            const shadeValueDisplay = document.getElementById('shadeOpacityValue');
            
            if (shadeSlider) {
                shadeSlider.addEventListener('input', function() {
                    const opacity = parseFloat(this.value);
                    shadeValueDisplay.textContent = opacity.toFixed(1);
                    
                    // Update opacity for all confidence bounds (shade) across all charts
                    d3.selectAll('.confidence-bounds')
                        .attr('opacity', opacity);
                });
            }
            
            // Date control
            const dateSelect = document.getElementById('dateSelect');
            
            if (dateSelect) {
                dateSelect.addEventListener('change', async function() {
                    currentStartDate = this.value;
                    console.log('Start date changed to:', currentStartDate);
                    
                    if (conditionFactory && conditionFactory.isInitialized()) {
                        try {
                            await conditionFactory.updateWithNewDate(currentStartDate);
                            
                            // Reapply current opacity settings
                            const currentAlternativeOpacity = parseFloat(alternativeSlider?.value || 0.2);
                            const currentShadeOpacity = parseFloat(shadeSlider?.value || 0.2);
                            d3.selectAll('.prediction-line')
                                .style('opacity', currentAlternativeOpacity);
                            d3.selectAll('.confidence-bounds')
                                .attr('opacity', currentShadeOpacity);
                                
                        } catch (error) {
                            console.error('Failed to update with new date:', error);
                        }
                    }
                });
            }
        }

        // Main initialization
        async function initializeVisualization() {
            try {
                console.log('Loading data and initializing condition factory...');
                
                // Load data
                const rawDataResponse = await d3.json('synthetic_stock_data.json');
                const rawData = rawDataResponse.data;
                
                // Create and initialize condition factory
                conditionFactory = new ConditionFactory();
                await conditionFactory.initialize(config, rawData, currentStartDate);
                
                console.log('Condition factory initialized, rendering all conditions...');
                
                // Render all 8 conditions
                await conditionFactory.renderAllConditions();
                
                console.log('All conditions rendered successfully');
                
                // Initialize controls
                initializeControls();
                
                // Log condition information
                const conditionInfo = ConditionFactory.getConditionInfo();
                console.log('Available conditions:', conditionInfo);
                
            } catch (error) {
                console.error('Failed to initialize visualization:', error);
                
                // Display error message
                const grid = document.querySelector('.visualization-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; color: red; padding: 20px;">
                            <h3>Error loading visualization</h3>
                            <p>Failed to load data or initialize conditions: ${error.message}</p>
                            <p>Please ensure synthetic_stock_data.json is available and all modules are accessible.</p>
                        </div>
                    `;
                }
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (conditionFactory) {
                conditionFactory.cleanup();
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure D3 is fully loaded
            setTimeout(initializeVisualization, 100);
        });
    </script>
</body>
</html>